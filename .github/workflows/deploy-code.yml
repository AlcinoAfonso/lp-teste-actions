name: ğŸš€ Deploy CÃ³digo Automaticamente

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'O que vocÃª estÃ¡ implementando? (ex: LP FitNutri - Lote 1)'
        required: true
        type: string
        default: 'Implementar nova funcionalidade'
      claude_response:
        description: 'Cole aqui EXATAMENTE o que o Claude escreveu (com arquivos e cÃ³digos)'
        required: true
        type: string
        default: |
          Exemplo:
          
          **Arquivo: src/components/Example.tsx**
          ```tsx
          import React from 'react';
          export default function Example() {
            return <div>Hello World</div>;
          }
          ```

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Claude Deploy Bot"
      
      - name: ğŸŒ¿ Criar nova branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="claude-deploy-$TIMESTAMP"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"
          echo "âœ… Branch criada: $BRANCH_NAME"
      
      - name: ğŸ“ Processar resposta do Claude
        run: |
          echo "ğŸ”„ Processando resposta do Claude..."
          
          # Salvar a resposta em um arquivo temporÃ¡rio
          cat > claude_response.txt << 'CLAUDE_EOF'
          ${{ inputs.claude_response }}
          CLAUDE_EOF
          
          echo "ğŸ“„ Resposta salva. Tamanho: $(wc -c < claude_response.txt) caracteres"
          
          # Mostrar primeiras linhas para debug
          echo "ğŸ” Primeiras linhas da resposta:"
          head -10 claude_response.txt
      
      - name: ğŸ› ï¸ Extrair e criar arquivos
        run: |
          echo "ğŸš€ Iniciando extraÃ§Ã£o de arquivos..."
          
          # Script Python inline para processar a resposta do Claude
          python3 << 'PYTHON_EOF'
          import re
          import os
          import sys
          
          def extract_files_from_claude_response(content):
              files = []
              
              # PadrÃ£o para encontrar arquivos: **Arquivo: caminho** ou Arquivo: caminho
              file_pattern = r'\*\*Arquivo:\s*([^\*\n]+)\*\*|^Arquivo:\s*(.+)$'
              
              # PadrÃ£o para blocos de cÃ³digo
              code_pattern = r'```(\w+)?\n(.*?)```'
              
              lines = content.split('\n')
              current_file = None
              
              i = 0
              while i < len(lines):
                  line = lines[i].strip()
                  
                  # Procurar por declaraÃ§Ã£o de arquivo
                  file_match = re.search(file_pattern, line, re.MULTILINE)
                  if file_match:
                      current_file = file_match.group(1) or file_match.group(2)
                      current_file = current_file.strip()
                      print(f"ğŸ“ Arquivo encontrado: {current_file}")
                      i += 1
                      continue
                  
                  # Procurar por bloco de cÃ³digo se temos um arquivo atual
                  if current_file and line.startswith('```'):
                      # Extrair linguagem se especificada
                      lang_match = re.match(r'```(\w+)?', line)
                      
                      # Coletar conteÃºdo do bloco
                      code_lines = []
                      i += 1
                      
                      while i < len(lines) and not lines[i].strip().startswith('```'):
                          code_lines.append(lines[i])
                          i += 1
                      
                      if code_lines:
                          code_content = '\n'.join(code_lines)
                          files.append({
                              'path': current_file,
                              'content': code_content
                          })
                          print(f"âœ… CÃ³digo extraÃ­do para {current_file} ({len(code_content)} caracteres)")
                      
                      current_file = None
                  
                  i += 1
              
              return files
          
          # Ler resposta do Claude
          with open('claude_response.txt', 'r', encoding='utf-8') as f:
              claude_content = f.read()
          
          # Extrair arquivos
          extracted_files = extract_files_from_claude_response(claude_content)
          
          if not extracted_files:
              print("âŒ Nenhum arquivo encontrado na resposta do Claude!")
              print("ğŸ” Verifique se o formato estÃ¡ correto:")
              print("   **Arquivo: caminho/arquivo.tsx**")
              print("   ```tsx")
              print("   cÃ³digo aqui")
              print("   ```")
              sys.exit(1)
          
          print(f"ğŸ“¦ Total de arquivos encontrados: {len(extracted_files)}")
          
          # Criar arquivos
          created_files = []
          for file_info in extracted_files:
              file_path = file_info['path']
              file_content = file_info['content']
              
              # Criar diretÃ³rio se necessÃ¡rio
              os.makedirs(os.path.dirname(file_path), exist_ok=True)
              
              # Escrever arquivo
              with open(file_path, 'w', encoding='utf-8') as f:
                  f.write(file_content)
              
              created_files.append(file_path)
              print(f"âœ… Arquivo criado: {file_path}")
          
          # Salvar lista de arquivos criados
          with open('created_files.txt', 'w') as f:
              for file_path in created_files:
                  f.write(file_path + '\n')
          
          print(f"ğŸ‰ Processo concluÃ­do! {len(created_files)} arquivos criados.")
          PYTHON_EOF
      
      - name: âœ… Verificar arquivos criados
        run: |
          echo "ğŸ“‹ Arquivos que foram criados:"
          if [ -f created_files.txt ]; then
            cat created_files.txt
            
            echo ""
            echo "ğŸ“Š Detalhes dos arquivos:"
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "  âœ… $file ($(wc -l < "$file") linhas)"
              else
                echo "  âŒ $file (nÃ£o encontrado)"
              fi
            done < created_files.txt
          else
            echo "âŒ Nenhum arquivo foi criado!"
            exit 1
          fi
      
      - name: ğŸ“¦ Commit das mudanÃ§as
        run: |
          git add .
          
          if git diff --staged --quiet; then
            echo "âŒ Nenhuma mudanÃ§a detectada para commit"
            exit 1
          fi
          
          git commit -m "ğŸ¤– ${{ inputs.description }}

          Arquivos criados via Claude Deploy:
          $(cat created_files.txt | sed 's/^/- /')
          
          Processado automaticamente em $(date)"
          
          echo "âœ… Commit criado com sucesso"
      
      - name: ğŸš€ Push da branch
        run: |
          git push origin $BRANCH_NAME
          echo "âœ… Branch $BRANCH_NAME enviada para GitHub"
      
      - name: ğŸ“‹ Criar Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Ler lista de arquivos criados
            let filesList = '';
            try {
              const files = fs.readFileSync('created_files.txt', 'utf8').trim().split('\n');
              filesList = files.map(file => `- \`${file}\``).join('\n');
            } catch (e) {
              filesList = '- Nenhum arquivo detectado';
            }
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¤– ${{ inputs.description }}',
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## ğŸ¤– Deploy AutomÃ¡tico via Claude

**DescriÃ§Ã£o:** ${{ inputs.description }}

**Branch:** \`${process.env.BRANCH_NAME}\`

**Data:** ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}

---

### ğŸ“ Arquivos criados/modificados:
${filesList}

### âœ… Checklist de revisÃ£o:
- [ ] ğŸ” CÃ³digo revisado
- [ ] ğŸ§ª Funcionalidade testada  
- [ ] ğŸ“± Responsivo verificado
- [ ] â™¿ Acessibilidade OK
- [ ] ğŸš€ Pronto para deploy

### ğŸ”— Links Ãºteis:
- [Ver mudanÃ§as detalhadas](${context.payload.repository.html_url}/pull/\${pr.number}/files)
- [Preview local](http://localhost:3000)

---

*ğŸ¤– Gerado automaticamente pelo Claude Deploy System*
              `
            });
            
            console.log(`âœ… Pull Request criado: #${pr.number}`);
            console.log(`ğŸ”— URL: ${pr.html_url}`);
            
            // Adicionar labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ğŸ¤– auto-deploy', 'ğŸ”„ claude-generated']
            });
            
            // ComentÃ¡rio adicional com instruÃ§Ãµes
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## ğŸ‰ Deploy automÃ¡tico concluÃ­do!

**âš¡ PrÃ³ximos passos:**
1. **Revisar cÃ³digo**: Clique na aba "Files changed" acima
2. **Testar localmente**: \`git checkout ${process.env.BRANCH_NAME}\` e \`npm run dev\`
3. **Aprovar**: Quando estiver tudo OK, clique em "Merge pull request"
4. **Deploy**: Vercel farÃ¡ deploy automÃ¡tico apÃ³s o merge

**ğŸš¨ Se algo deu errado:**
- Feche este PR
- Execute o workflow novamente
- Ou edite os arquivos manualmente

---
*Sistema Claude Deploy v1.0*`
            });

      - name: ğŸ‰ FinalizaÃ§Ã£o
        run: |
          echo ""
          echo "ğŸ‰ ===== DEPLOY CONCLUÃDO COM SUCESSO! ====="
          echo ""
          echo "âœ… Branch criada: $BRANCH_NAME"
          echo "âœ… Arquivos processados: $(wc -l < created_files.txt)"
          echo "âœ… Pull Request criado automaticamente"
          echo ""
          echo "ğŸ”„ PrÃ³ximos passos:"
          echo "  1. VÃ¡ para a aba 'Pull requests' do repositÃ³rio"
          echo "  2. Revise o cÃ³digo criado"
          echo "  3. FaÃ§a merge quando estiver OK"
          echo "  4. Vercel farÃ¡ deploy automÃ¡tico"
          echo ""
          echo "ğŸ”— Acesse: https://github.com/${{ github.repository }}/pulls"
          echo ""
